<!DOCTYPE html>
<html>
    <head>
        <title>Live Stream App</title>
    </head>
    <body>
        <h2>Live Streaming</h2>
        <video id="localVideo" autoplay muted playsinline></video>
        <div id="remoteVideo"></div>
        <video class="remoteVideo" autoplay playsinline></video>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const peerConnection = new RTCPeerConnection();

            navigator.mediaDevices
                .getUserMedia({ video: true, audio: true })
                .then((stream) => {
                    localVideo.srcObject = stream;
                    stream
                        .getTracks()
                        .forEach((track) =>
                            peerConnection.addTrack(track, stream)
                        );
                });

            peerConnection.ontrack = (event) => {
                event.streams.map((streams) => {
                    var video = document.createElement('video');
                    video.autoplay = true;
                    video.playsinline = true;
                    video.srcObject = streams;
                    remoteVideo.append(video);
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', event.candidate);
                }
            };

            socket.on('offer', async (offer) => {
                await peerConnection.setRemoteDescription(
                    new RTCSessionDescription(offer)
                );
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', answer);
            });

            socket.on('answer', async (answer) => {
                await peerConnection.setRemoteDescription(
                    new RTCSessionDescription(answer)
                );
            });

            socket.on('ice-candidate', (candidate) => {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            });

            async function createOffer() {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                socket.emit('offer', offer);
            }

            // Initiate connection after a few seconds
            setTimeout(createOffer, 1000);
        </script>
    </body>
</html>
